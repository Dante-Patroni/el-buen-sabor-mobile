name: Flutter CI/CD

# ğŸ¯ CUÃNDO SE EJECUTA ESTE WORKFLOW
# - En cada push a main o develop
# - En cada Pull Request
# - Manualmente desde GitHub Actions
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:  # Permite ejecutar manualmente

# ğŸ”§ JOBS (Trabajos a ejecutar)
jobs:
  # ============================================================================
  # ğŸ“Š JOB 1: ANÃLISIS Y TESTS
  # ============================================================================
  test:
    name: AnÃ¡lisis y Tests
    runs-on: ubuntu-latest  # Sistema operativo donde se ejecuta
    
    steps:
      # PASO 1: Descargar el cÃ³digo del repositorio
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
      
      # PASO 2: Instalar Flutter
      - name: ğŸ”§ Configurar Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'  # VersiÃ³n de Flutter
          channel: 'stable'           # Canal estable
      
      # PASO 3: Verificar instalaciÃ³n de Flutter
      - name: âœ… Verificar Flutter
        run: flutter --version
      
      # PASO 4: Instalar dependencias
      - name: ğŸ“¦ Instalar dependencias
        run: flutter pub get
      
      # PASO 5: Generar mocks para tests
      - name: ğŸ­ Generar mocks
        run: flutter pub run build_runner build --delete-conflicting-outputs
      
      # PASO 6: AnÃ¡lisis estÃ¡tico del cÃ³digo
      - name: ğŸ” AnÃ¡lisis estÃ¡tico (flutter analyze)
        run: flutter analyze
      
      # PASO 7: Ejecutar todos los tests
      - name: ğŸ§ª Ejecutar tests
        run: flutter test --coverage
      
      # PASO 8: Subir reporte de cobertura a Codecov (opcional)
      - name: ğŸ“Š Subir cobertura a Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage/lcov.info
          fail_ci_if_error: false  # No fallar si Codecov falla
      
      # PASO 9: Generar reporte de cobertura HTML
      - name: ğŸ“ˆ Generar reporte HTML de cobertura
        run: |
          sudo apt-get update
          sudo apt-get install -y lcov
          genhtml coverage/lcov.info -o coverage/html
      
      # PASO 10: Subir reporte como artifact
      - name: ğŸ“¤ Subir reporte de cobertura
        uses: actions/upload-artifact@v3
        with:
          name: coverage-report
          path: coverage/html

  # ============================================================================
  # ğŸ—ï¸ JOB 2: BUILD APK (Solo en push a main)
  # ============================================================================
  build:
    name: Build APK
    runs-on: ubuntu-latest
    needs: test  # Solo se ejecuta si los tests pasan
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Configurar Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
      
      - name: ğŸ“¦ Instalar dependencias
        run: flutter pub get
      
      - name: ğŸ—ï¸ Build APK
        run: flutter build apk --release
      
      - name: ğŸ“¤ Subir APK
        uses: actions/upload-artifact@v3
        with:
          name: app-release
          path: build/app/outputs/flutter-apk/app-release.apk

# ============================================================================
# ğŸ“ EXPLICACIÃ“N DETALLADA
# ============================================================================
#
# Â¿QUÃ‰ HACE ESTE ARCHIVO?
# Este archivo configura CI/CD (IntegraciÃ³n Continua / Despliegue Continuo)
# para tu proyecto Flutter. Cada vez que haces push o creas un PR, GitHub
# automÃ¡ticamente:
# 1. Ejecuta flutter analyze (busca errores)
# 2. Ejecuta todos los tests
# 3. Genera reporte de cobertura
# 4. (Opcional) Compila el APK
#
# Â¿POR QUÃ‰ ES IMPORTANTE?
# - Detecta errores antes de que lleguen a producciÃ³n
# - Asegura que los tests siempre pasen
# - Genera reportes automÃ¡ticos
# - Demuestra profesionalismo en la tesis
#
# Â¿CÃ“MO SE USA?
# 1. Crear carpeta: .github/workflows/
# 2. Guardar este archivo como: flutter-ci.yml
# 3. Hacer commit y push
# 4. Ver resultados en: GitHub â†’ Actions
#
# ============================================================================
